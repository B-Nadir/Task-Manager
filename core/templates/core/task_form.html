{% extends "core/base.html" %}
{% load static %}
{% block content %}

<div class="max-w-3xl mx-auto mt-6">

  <!-- Back Button -->
  <a href="{% url 'task_list' %}"
     class="inline-block mb-4 px-4 py-2 rounded-lg bg-dark text-grey hover:bg-primary transition shadow">
     ← Task List
  </a>

  <!-- Page Header -->
  <div class="text-center mb-8">
    <h2 class="text-3xl font-serif font-bold text-dark">{{ title|default:"Task Form" }}</h2>
    <p class="text-dark text-sm">Please fill in all required details</p>
  </div>

  <form method="post" enctype="multipart/form-data" class="space-y-6">
    {% csrf_token %}

    <!-- Basic Details -->
    <div class="bg-light border border-soft rounded-xl shadow p-6 space-y-4">
      <h3 class="font-serif text-lg font-bold text-center">Basic Details</h3>
      {{ form.title }}
      {{ form.description }}
    </div>

    <!-- Task Steps with User Selection -->
    <div class="bg-light border border-soft rounded-xl shadow p-6 space-y-4" x-data="taskSteps()">
      <h3 class="font-serif text-lg font-bold text-center">Task Steps</h3>

      <button type="button" @click="addStep()"
        class="px-4 py-2 bg-accent text-grey rounded-lg hover:bg-dark transition shadow">
        Add Step
      </button>

      <template x-for="(step, index) in steps" :key="index">
        <div class="border border-soft rounded-lg p-4 mt-3 bg-grey shadow-sm space-y-3">

          <input type="text" :name="'step_title[]'" x-model="step.title"
            placeholder="Step Title"
            class="w-full px-4 py-2 rounded-xl border border-soft bg-light focus:border-primary focus:ring-2 focus:ring-primary" />

          <textarea :name="'step_description[]'" x-model="step.description" rows="2"
            placeholder="Step Description"
            class="w-full px-4 py-2 rounded-xl border border-soft bg-light resize-none focus:border-primary focus:ring-2 focus:ring-primary"></textarea>

          <!-- Step Assignee Dropdown -->
          <div x-data="{ openStep: false, stepSelected: [] }" class="relative">
            <button type="button" @click="openStep = !openStep"
              class="w-full px-4 py-2 rounded-xl border border-soft bg-light text-left flex justify-between items-center">
              <span>Select Assignee</span>
              <span x-text="stepSelected.length ? '(' + stepSelected.length + ' selected)' : '▼'"></span>
            </button>

            <div x-show="openStep" @click.outside="openStep = false"
              class="absolute left-0 w-full mt-2 bg-grey border border-soft rounded-xl p-3 max-h-40 overflow-y-auto z-10 shadow">

              {% for user in form.fields.assigned_to.queryset %}
              <label class="flex items-center space-x-2 cursor-pointer mb-1">
                <input type="checkbox" 
                      :name="'step_assigned_to[]'" 
                      value="{{ user.id }}"
                      @change="updateStepSelection($el, stepSelected)"
                      {% if user in form.instance.assigned_to.all %}
                        checked x-init="stepSelected.push('{{ user.get_full_name }}')"
                      {% endif %}
                      class="h-4 w-4 rounded border-soft text-primary" />
                <span>{{ user.get_full_name }}</span>
              </label>
              {% endfor %}

            </div>
          </div>

          <input type="hidden" :name="'step_order[]'" :value="index + 1">

          <button type="button" @click="removeStep(index)"
            class="px-3 py-1 bg-danger text-grey rounded-lg hover:bg-dark transition">
            Remove
          </button>
        </div>
      </template>
    </div>

    <!-- Due Date -->
    <div class="bg-light border border-soft rounded-xl shadow p-6">
      <h3 class="font-serif text-lg font-bold text-center mb-4">Due Date</h3>
      {{ form.due_date }}
    </div>

    <!-- Tags -->
    <div class="bg-light border border-soft rounded-xl shadow p-6 space-y-4">
      <h3 class="font-serif text-lg font-bold text-center">Tags</h3>
      <div x-data="{ open:false, selected: [] }" class="relative">
        <button type="button" @click="open = !open"
          class="w-full px-4 py-2 rounded-xl border border-soft bg-grey shadow-sm text-left flex justify-between">
          <span>Select Tags</span>
          <span x-text="selected.length ? '(' + selected.length + ' selected)' : '▼'"></span>
        </button>

        <div x-show="open" @click.outside="open=false"
          class="absolute w-full mt-2 bg-grey border border-soft rounded-xl p-3 max-h-40 overflow-y-auto z-10 shadow">
          {% for checkbox in form.tags %}
            <label class="flex items-center space-x-2">
              <input type="checkbox" name="{{ checkbox.data.name }}" value="{{ checkbox.data.value }}"
                {% if checkbox.data.selected %}checked x-init="selected.push('{{ checkbox.choice_label }}')" {% endif %}
                @change="updateTagSelection($el)"
                class="h-4 w-4 rounded border-soft text-primary" />
              <span>{{ checkbox.choice_label }}</span>
            </label>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Assign Users -->
    <div class="bg-light border border-soft rounded-xl shadow p-6 space-y-4">
      <h3 class="font-serif text-lg font-bold text-center">Assign Users</h3>
      <div x-data="{ open: false, selected: [] }" class="relative">
        <button type="button" @click="open = !open"
          class="w-full px-4 py-2 rounded-xl border border-soft bg-grey flex justify-between">
          <span>Select Users</span>
          <span x-text="selected.length ? '(' + selected.length + ' selected)' : '▼'"></span>
        </button>

        <div x-show="open" @click.outside="open=false"
          class="absolute w-full p-3 mt-2 bg-grey border border-soft rounded-xl shadow max-h-40 overflow-y-auto">
          {% for checkbox in form.assigned_to %}
          <label class="flex items-center space-x-2 cursor-pointer mb-1">
            <input type="checkbox"
                  name="{{ checkbox.data.name }}"
                  value="{{ checkbox.data.value }}"
                  @change="updateSelection($el)"
                  {% if checkbox.data.selected %}
                    checked x-init="selected.push('{{ checkbox.choice_label }}')"
                  {% endif %}
                  class="h-4 w-4 rounded border-soft text-primary checked:bg-primary checked:border-primary" />
            <span>{{ checkbox.choice_label }}</span>
          </label>
          {% endfor %}

        </div>
      </div>
    </div>

    <!-- Attachments -->
    <div class="bg-light border border-soft rounded-xl shadow p-6 text-center">
      <h3 class="font-serif text-lg font-bold mb-2">Attachments</h3>
      <input type="file" name="attachments" multiple
        class="block w-full file:cursor-pointer file:py-2 file:px-4 file:rounded-xl file:bg-primary file:text-grey hover:file:bg-dark transition">
    </div>

    <!-- Submit -->
    <div class="text-center pt-4">
      <button type="submit"
        class="px-6 py-2 bg-primary text-grey rounded-xl hover:bg-dark shadow-md transition">
        {{ title|default:"Save" }}
      </button>
    </div>

  </form>
</div>

<script>
  function taskSteps() {
    return {
      steps: [],
      addStep() { this.steps.push({ title: '', description: '', assigned_to: '' }); },
      removeStep(i) { this.steps.splice(i, 1); }
    };
  }

  function updateSelection(el) {
    let selected = el.closest('[x-data]').__x.$data.selected;
    const label = el.nextElementSibling.innerText;
    el.checked ? selected.push(label) : selected.splice(selected.indexOf(label), 1);
  }

  function updateTagSelection(el) {
    let selected = el.closest('[x-data]').__x.$data.selected;
    const label = el.nextElementSibling.innerText;
    el.checked ? selected.push(label) : selected.splice(selected.indexOf(label), 1);
  }

  function updateStepSelection(el, arr) {
    const label = el.nextElementSibling.innerText;
    el.checked ? arr.push(label) : arr.splice(arr.indexOf(label), 1);
  }
</script>

{% endblock %}
